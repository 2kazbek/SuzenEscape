# TODO

## Идея

Для того чтобы написать какое-либо задание в первую очередь следует определить к какому типу вы его отнесете:
* флаг лежит в контейнере (напрмиер см уровни 1-4)
* флаг приносится внешним чекером (например см уровни 19-24)
* флаг достается по сети посредством взаимодействия с другим сервером (например см уровни 5,9)

## Структура

Структурно задания обычно выстраиваются в цепочки, так чтобы полученный флаг от предыдущего задания
можно было использовать как пароль для входа на следующее. Такой подход не обязателен в случае сложных заданий или
в качестве временного решения, пока цепочка не допишется

Задание представляет из себя папку, расположенную следующим образом:
```{root_project_dir}/chainX/levelY```
Таким образом любое задание входит в какую-нибудь цепочку (даже если оно там одно), а внутри каталога-цепочки должен быть
каталог с названием level + порядковый номер этого задания.

## Составляющие части задания

Необходимым и достаточным условием для сборки уровня является наличие Dockerfile в папке с уровнем.
Любые необходимые для сборки уровня файлы и каталоги должны также находиться в папке рядом с Dockerfile,
таким образом, чтобы сборка уровня была самодостаточна и не выходила за пределы директории с уровнем.

## Обязательные условия

Для того чтобы свести к минимуму повторения стратегических вещей, существует единый файл, содержащий
всю необходимую информацию по уровню: ansible/vars.yaml

При создании нового уровня следует по образцу поместить в массив levels[] новую цепочку
и создать элемент со следующими параметрами:
```yaml
- name    : suzenXX # имя задания, включая его номер (обязательное поле)
  image   : myctf.ru:5000/suzenescape/suzenXX # адрес репозитория
  password: "" # Флаг от предыдущего уровня или традиционно пароль = suzenXX, где XX - номер первого задания в цепочке (обязательное поле)
  sault   : "" # соль для пароля в /etc/passwd (6-8 любых символов) (обязательное поле)
  flag    : "" # флаг, который будет положен в задание при его генерировании (обязательное поле)
  config  : "" # при использовании bykva/busybinaries это набор исполняемых файлов, оставляемых после сборки задания.
  chain   : "" # номер цепочки в которую входит задание (обязательное поле)
```

Таким образом, ваш контейнер ОБЯЗАН принимать в качестве аргументов как минимум FLAG и использовать его при сборке уровня.
Наличие заданий, в которые флаг вшит жестко недопустимы, за редким исключением и оговариваются с автором проекта отдельно.

для генерирования флага я использую команду:
```pwgen 20 1 | base64```

## Этапы сборки нового задания

* Создать директорию chainX/levelY
* Создать запись с нужными параметрами в ansible/vars.yaml
* Написать Dockerfile и положить необходимые файлы
* Собрать задания, используя команду ./build.sh XX, где XX - номер уровня (можно использовать
  ./build.py XX)
* В случае если задание подразумевает внешнюю проверку, то сделать файл проверки:
  ansible/roles/deploy_tasks/templates/suzenXX.j2, где ХХ - номер уровня.
  Данный файл является bash-скриптом, которому передадут в качестве аргумента ID контейнера с нужным уровнем.
  Задача скрипта - выполнить exec внутрю контейнера, убедиться в выполненности задания, и если это так - положить флаг.

## Этапы раскатки нового задания на прод

После того как задание было успешно оттестировано локально, для раскатки на прод достаточно просто запустить ansible или
если вы используете vagrant просто ввести команду ```vagrant provision```

## Проверка

После раскатки образа в игровую платформу, подключитесь по ssh под логином, включающим номер вашего уровня,
затем выполните проверку работоспособности.


## Полезные команды

Для ускорения пересборки ВМ используйте такую команду:
```text
vagrant reload -f --provision
или
vagrant rsync && vagrant provision
```
Что позволит выгрузить ваши наработки в ВМ и пройтись по ним ансиблом